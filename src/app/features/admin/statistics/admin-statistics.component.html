<app-page-layout title="Estadísticas Generales" icon="bar_chart">
    <div class="stats-container">

        <!-- Filter Bar -->
        <div class="card filter-card">
            <div class="filter-row">
                <div class="form-group">
                    <label>Año</label>
                    <input type="number" [(ngModel)]="selectedAnio" class="form-control" placeholder="Todos">
                </div>
                <div class="form-group">
                    <label>Facultad</label>
                    <select [(ngModel)]="selectedFacultad" class="form-control">
                        <option value="">Todas</option>
                        @for (fac of facultades; track fac.id) {
                        <option [value]="fac.id">{{ fac.nombreCompleto }}</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label>Carrera</label>
                    <select [(ngModel)]="selectedCarrera" class="form-control">
                        <option value="">Todas</option>
                        @for (car of carreras; track car.id) {
                        <option [value]="car.id">{{ car.nombre }}</option>
                        }
                    </select>
                </div>
                <div class="filter-actions">
                    <button class="btn-primary" (click)="applyFilters()" [disabled]="isLoading">
                        <span class="material-icons">filter_list</span> Aplicar
                    </button>
                </div>
            </div>
        </div>

        @if (isLoading) {
        <app-loading-spinner message="Calculando estadísticas..."></app-loading-spinner>
        } @else if (stats) {

        <h3 class="section-header">Población Estudiantil</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">groups</span>
                    <span>Total Alumnos</span>
                </div>
                <div class="stat-value">{{ stats.cantidadTotalAlumnos }}</div>
                <div class="stat-label">Alumnos registrados en el sistema</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">school</span>
                    <span>Regulares</span>
                </div>
                <div class="stat-value">{{ stats.cantidadRegulares }}</div>
                <div class="stat-label">Alumnos cursando regularmente</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">sentiment_very_dissatisfied</span>
                    <span>Libres</span>
                </div>
                <div class="stat-value">{{ stats.cantidadLibres }}</div>
                <div class="stat-label">Alumnos en condición de libre</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">emoji_events</span>
                    <span>Promocionados</span>
                </div>
                <div class="stat-value">{{ stats.cantidadPromocionados }}</div>
                <div class="stat-label">Materias promocionadas</div>
            </div>
        </div>

        <h3 class="section-header">Rendimiento en Exámenes</h3>
        <div class="stats-grid">
            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">assignment_turned_in</span>
                    <span>Inscriptos a Examen</span>
                </div>
                <div class="stat-value">{{ stats.cantidadTotalInscriptosExamen }}</div>
                <div class="stat-label">Total inscripciones a mesas</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">check_circle</span>
                    <span>Aprobados</span>
                </div>
                <div class="stat-value">{{ stats.cantidadAprobadosExamen }}</div>
                <div class="stat-label">Exámenes aprobados</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">cancel</span>
                    <span>Desaprobados</span>
                </div>
                <div class="stat-value">{{ stats.cantidadDesaprobadosExamen }}</div>
                <div class="stat-label">Exámenes desaprobados</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">event_busy</span>
                    <span>Ausentes</span>
                </div>
                <div class="stat-value">{{ stats.cantidadAusentesExamen }}</div>
                <div class="stat-label">Ausentes en exámenes</div>
            </div>

            <div class="stat-card">
                <div class="card-header">
                    <span class="material-icons">trending_up</span>
                    <span>Promedio General</span>
                </div>
                <div class="stat-value">{{ stats.notaPromedio | number:'1.2-2' }}</div>
                <div class="stat-label">Promedio de notas de exámenes</div>
            </div>
        </div>

        <!-- Charts Section -->
        <h3 class="section-header">Gráficos</h3>
        <div class="charts-grid">
            <div class="chart-card">
                <h4>Resultados de Exámenes</h4>
                <div class="chart-wrapper">
                    <ngx-charts-pie-chart [scheme]="examColorScheme" [results]="examChartData" [gradient]="true"
                        [legend]="false" [doughnut]="true" [labels]="false">
                    </ngx-charts-pie-chart>
                </div>
                <div class="custom-legend">
                    <div class="legend-item">
                        <span class="color-dot" style="background-color: #10b981;"></span>
                        <span>Aprobados</span>
                    </div>
                    <div class="legend-item">
                        <span class="color-dot" style="background-color: #ef4444;"></span>
                        <span>Desaprobados</span>
                    </div>
                    <div class="legend-item">
                        <span class="color-dot" style="background-color: #f59e0b;"></span>
                        <span>Ausentes</span>
                    </div>
                </div>
            </div>

            <div class="chart-card">
                <h4>Condición de Alumnos</h4>
                <div class="chart-wrapper">
                    <ngx-charts-bar-vertical [scheme]="studentColorScheme" [results]="studentChartData"
                        [gradient]="true" [xAxis]="true" [yAxis]="true" [showXAxisLabel]="false" [showYAxisLabel]="true"
                        yAxisLabel="Cantidad">
                    </ngx-charts-bar-vertical>
                </div>
            </div>
        </div>
        }
    </div>
</app-page-layout>