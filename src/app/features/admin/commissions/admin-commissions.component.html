<app-page-layout title="Gestión de Comisiones" icon="class">
    <div class="content-container">

        @if (isLoading) {
        <app-loading-spinner></app-loading-spinner>
        } @else {

        @if (viewMode === 'LIST') {
        <div class="card toolbar-card">
            <button class="btn-primary" (click)="openCreateModal()">
                <span class="material-icons">add</span> Nueva Comisión
            </button>
        </div>

        <div class="commissions-grid">
            @for (comision of comisiones; track comision.id) {
            <div class="card comision-card" (click)="selectComision(comision)">
                <div class="card-header">
                    <h4>{{ comision.nombre }} - {{ comision.anio }}</h4>
                    <span class="badge">{{ comision.turno }}</span>
                </div>
                <div class="card-body">
                    <p><span class="material-icons">room</span> {{ comision.nombreSalon }}</p>
                    <p><span class="material-icons">menu_book</span> {{ (comision.materias || []).length }}
                        Materias
                        Asignadas
                    </p>
                </div>
            </div>
            } @empty {
            <div class="empty-state">
                <span class="material-icons">class</span>
                <p>No hay comisiones registradas.</p>
            </div>
            }
        </div>
        }

        
        @if (viewMode === 'DETAILS' && selectedComision) {
        <div class="card details-card">
            <div class="details-header">
                <h3>{{ selectedComision.nombre }} ({{ selectedComision.anio }})</h3>
                <div class="header-actions">
                    <button class="btn-primary" (click)="openAssignModal()">
                        <span class="material-icons">add_circle</span> Agregar Materia
                    </button>
                    <button class="btn-outline" (click)="backToList()">Volver</button>
                </div>
            </div>

            <div class="table-responsive">
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Materia</th>
                            <th>Inscriptos</th>
                            <th>Profesores</th>
                            <th>Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        @for (materia of (selectedComision.materias || []); track materia.idMateria) {
                        <tr>
                            <td>
                                <div class="cell-content">
                                    <span class="material-icons text-muted">menu_book</span>
                                    <span>{{ materia.nombreMateria }}</span>
                                </div>
                            </td>
                            <td>
                                <span class="badge">{{ materia.cantidadInscriptos }}</span>
                            </td>
                            <td>
                                <div class="prof-list">
                                    @for (prof of materia.profesores; track prof.idUsuario) {
                                    <span class="tag">{{ prof.apellido }}</span>
                                    } @empty {
                                    <span class="text-secondary italic">Sin asignar</span>
                                    }
                                </div>
                            </td>
                            <td>
                                @if (materia.cantidadInscriptos === 0) {
                                <button class="icon-btn danger" title="Desasignar">
                                    <span class="material-icons">delete</span>
                                </button>
                                }
                            </td>
                        </tr>
                        } @empty {
                        <tr>
                            <td colspan="5" class="text-center py-4">
                                <div class="empty-state-small">
                                    <span class="material-icons">playlist_remove</span>
                                    <p>No hay materias asignadas a esta comisión.</p>
                                </div>
                            </td>
                        </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
        }

        }

    </div>

    
    @if (showModal) {
    <div class="modal-overlay" (click)="closeCreateModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h4>Nueva Comisión</h4>
            <div class="form-group">
                <label>Nombre de Comisión</label>
                <input type="text" [(ngModel)]="newComision.nombre" class="form-control" placeholder="Ej: 1K1">
            </div>

            <div class="form-group">
                <label>Carrera</label>
                <select [(ngModel)]="newComision.idCarrera" class="form-control">
                    <option value="" disabled selected>Seleccione una opción</option>
                    @for (carrera of carreras; track carrera.id) {
                    <option [value]="carrera.id">{{ carrera.nombre }}</option>
                    }
                </select>
            </div>

            <div class="form-group">
                <label>Nivel</label>
                <input type="number" [(ngModel)]="newComision.nivel" class="form-control" placeholder="1, 2, 3..."
                    min="1" max="5">
            </div>

            <div class="form-group">
                <label>Año Académico</label>
                <input type="number" [(ngModel)]="newComision.anio" (change)="onTurnoOrAnioChange()"
                    class="form-control" placeholder="Ej: 2025">
            </div>

            <div class="form-group">
                <label>Turno</label>
                <select [(ngModel)]="newComision.turno" (change)="onTurnoOrAnioChange()" class="form-control">
                    <option value="" disabled selected>Seleccione una opción</option>
                    <option value="Mañana">Mañana</option>
                    <option value="Tarde">Tarde</option>
                    <option value="Noche">Noche</option>
                </select>
            </div>

            <div class="form-group">
                <label>Salón Asignado</label>
                <select [(ngModel)]="newComision.idSalon" class="form-control"
                    [disabled]="!newComision.turno || !newComision.anio">
                    <option value="" disabled selected>Seleccione una opción</option>
                    @for (salon of salones; track salon.id) {
                    <option [value]="salon.id">{{ salon.nombre }}</option>
                    }
                </select>
            </div>

            <div class="modal-actions">
                <button class="btn-secondary" (click)="closeCreateModal()">Cancelar</button>
                <button class="btn-primary" (click)="createComision()" [disabled]="isLoading">Crear</button>
            </div>
        </div>
    </div>
    }

    
    @if (showAssignModal) {
    <div class="modal-overlay" (click)="closeAssignModal()">
        <div class="modal-content assignment-modal" (click)="$event.stopPropagation()">
            
            <div class="step-indicator">
                <div class="step" [class.active]="assignStep === 'SUBJECT'"
                    [class.completed]="assignStep !== 'SUBJECT'">
                    <span class="step-number">1</span>
                    <span class="step-label">Materia</span>
                </div>
                <div class="step-divider"></div>
                <div class="step" [class.active]="assignStep === 'SCHEDULE'"
                    [class.completed]="assignStep === 'PROFESSORS'">
                    <span class="step-number">2</span>
                    <span class="step-label">Horarios</span>
                </div>
                <div class="step-divider"></div>
                <div class="step" [class.active]="assignStep === 'PROFESSORS'">
                    <span class="step-number">3</span>
                    <span class="step-label">Profesores</span>
                </div>
            </div>

            
            @if (assignStep === 'SUBJECT') {
            <div class="modal-header">
                <h4>Seleccionar Materia</h4>
            </div>
            <div class="modal-body">
                @if (isLoading) {
                <div class="loading-state">
                    <span class="material-icons rotating">hourglass_empty</span>
                    <p>Cargando materias disponibles...</p>
                </div>
                } @else {
                <div class="subject-list">
                    @for (materia of availableSubjects; track materia.id) {
                    <div class="subject-card" (click)="selectSubject(materia)">
                        <div class="subject-info">
                            <h5>{{ materia.nombre }}</h5>
                            <div class="subject-meta">
                                <span class="meta-item">
                                    <span class="material-icons">layers</span> Nivel {{ materia.nivel }}
                                </span>
                                <span class="meta-item">
                                    <span class="material-icons">schedule</span> {{ materia.horasCursado }} horas/semana
                                </span>
                                @if (materia.codigo) {
                                <span class="meta-item">
                                    <span class="material-icons">tag</span> {{ materia.codigo }}
                                </span>
                                }
                            </div>
                        </div>
                        <span class="material-icons chevron">chevron_right</span>
                    </div>
                    } @empty {
                    <div class="empty-state-small">
                        <span class="material-icons">search_off</span>
                        <p>No hay materias disponibles para asignar</p>
                    </div>
                    }
                </div>
                }
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" (click)="closeAssignModal()">Cancelar</button>
            </div>
            }

            
            @if (assignStep === 'SCHEDULE') {
            <div class="modal-header">
                <h4>Definir Horarios</h4>
                @if (selectedSubject) {
                <p class="subject-selected">{{ selectedSubject.nombre }} - {{ selectedSubject.horasCursado }}
                    horas/semana</p>
                }
            </div>
            <div class="modal-body">
                <div class="schedule-form">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Día</label>
                            <select [(ngModel)]="newSchedule.dia" class="form-control">
                                <option value="LUNES">Lunes</option>
                                <option value="MARTES">Martes</option>
                                <option value="MIERCOLES">Miércoles</option>
                                <option value="JUEVES">Jueves</option>
                                <option value="VIERNES">Viernes</option>
                                <option value="SABADO">Sábado</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Desde</label>
                            <input type="time" [(ngModel)]="newSchedule.horaDesde" class="form-control">
                        </div>
                        <div class="form-group">
                            <label>Hasta</label>
                            <input type="time" [(ngModel)]="newSchedule.horaHasta" class="form-control">
                        </div>
                        <div class="form-group align-end">
                            <button class="btn-primary" (click)="addSchedule()"
                                [disabled]="!newSchedule.horaDesde || !newSchedule.horaHasta">
                                <span class="material-icons">add</span> Agregar
                            </button>
                        </div>
                    </div>
                </div>

                <div class="schedule-list">
                    @if (scheduleList.length > 0) {
                    <h5>Horarios Definidos</h5>
                    @for (schedule of scheduleList; track $index) {
                    <div class="schedule-item">
                        <span class="schedule-day">{{ schedule.dia }}</span>
                        <span class="schedule-time">{{ schedule.horaDesde }} - {{ schedule.horaHasta }}</span>
                        <button class="icon-btn delete-btn" (click)="removeSchedule($index)">
                            <span class="material-icons">delete</span>
                        </button>
                    </div>
                    }

                    <div class="hours-indicator" [class.valid]="validateSchedules()"
                        [class.invalid]="!validateSchedules()">
                        <span class="material-icons">{{ validateSchedules() ? 'check_circle' : 'error' }}</span>
                        <span>{{ calculateTotalHours() }} / {{ selectedSubject?.horasCursado || 0 }} horas</span>
                    </div>
                    } @else {
                    <p class="text-muted">No se han agregado horarios aún</p>
                    }
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" (click)="backToStep('SUBJECT')">
                    <span class="material-icons">arrow_back</span> Atrás
                </button>
                <button class="btn-primary" (click)="goToStep3()" [disabled]="!validateSchedules() || isLoading">
                    Buscar Profesores <span class="material-icons">arrow_forward</span>
                </button>
            </div>
            }

            
            @if (assignStep === 'PROFESSORS') {
            <div class="modal-header">
                <h4>Seleccionar Profesores</h4>
                @if (selectedSubject) {
                <p class="subject-selected">{{ selectedSubject.nombre }}</p>
                }
            </div>
            <div class="modal-body">
                <div class="schedule-summary">
                    <h5>Horarios Definidos</h5>
                    @for (schedule of scheduleList; track $index) {
                    <span class="schedule-badge">{{ schedule.dia }} {{ schedule.horaDesde }}-{{ schedule.horaHasta
                        }}</span>
                    }
                </div>

                @if (isLoading) {
                <div class="loading-state">
                    <span class="material-icons rotating">hourglass_empty</span>
                    <p>Buscando profesores disponibles...</p>
                </div>
                } @else {
                <div class="professor-list">
                    @for (profesor of availableProfessors; track profesor.id) {
                    <div class="professor-item" [class.selected]="selectedProfessorIds.includes(profesor.id)"
                        (click)="toggleProfessor(profesor.id)">
                        <div class="professor-info">
                            <span class="professor-name">{{ profesor.apellido }}, {{ profesor.nombre }}</span>
                            <span class="professor-legajo">Legajo: {{ profesor.legajo }}</span>
                        </div>
                        <span class="material-icons checkbox">
                            {{ selectedProfessorIds.includes(profesor.id) ? 'check_box' : 'check_box_outline_blank' }}
                        </span>
                    </div>
                    } @empty {
                    <div class="empty-state-small">
                        <span class="material-icons">person_off</span>
                        <p>No hay profesores disponibles en estos horarios</p>
                    </div>
                    }
                </div>
                }

                @if (selectedProfessorIds.length > 0) {
                <p class="selected-count">{{ selectedProfessorIds.length }} profesor(es) seleccionado(s)</p>
                }
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" (click)="backToStep('SCHEDULE')">
                    <span class="material-icons">arrow_back</span> Atrás
                </button>
                <button class="btn-primary" (click)="finalizeAssignment()"
                    [disabled]="selectedProfessorIds.length === 0 || isLoading">
                    <span class="material-icons">check</span> Confirmar Asignación
                </button>
            </div>
            }
        </div>
    </div>
    }
</app-page-layout>