<app-page-layout title="Gestión de Mesas de Examen" icon="assignment">
    <div class="content-container">

        
        @if (!isLoading) {
        <div class="card toolbar-card">
            <button class="btn-primary" (click)="openCreateTurnModal()">
                <span class="material-icons">add</span> Nuevo Turno
            </button>
        </div>
        }

        
        @if (isLoading) {
        <app-loading-spinner></app-loading-spinner>
        } @else {
        
        <div class="turns-grid">
            @for (turno of turns; track turno.id) {
            <div class="card turn-card" [class.active]="isTurnActive(turno)" [class.past]="isTurnPast(turno)"
                (click)="selectTurno(turno)">
                <div class="turn-header">
                    <span class="material-icons turn-icon">event_note</span>
                    <h4>{{ turno.nombre }}</h4>
                </div>
                <div class="turn-stats">
                    <span class="stat-count">{{ getMesasCount(turno) }}</span>
                    <span class="stat-label">Mesas de Examen</span>
                </div>
                <div class="turn-dates text-muted small mt-2">
                    Del {{ turno.fechaInicio | date:"d 'de' MMMM" }} <br>
                    al {{ turno.fechaFin | date:"d 'de' MMMM 'de' yyyy" }}
                </div>
                <div class="turn-dates text-muted small mt-1">
                    <strong>Inscriptos:</strong> {{ turno.cantidadInscriptos }}
                </div>
                
                @if (!isTurnPast(turno)) {
                <div class="turn-actions mt-3 d-flex justify-content-center gap-3">
                    <button class="icon-btn" (click)="editTurno(turno, $event)" title="Editar Turno">
                        <span class="material-icons">edit</span>
                    </button>
                    @if (turno.cantidadInscriptos === 0) {
                    <button class="icon-btn delete" (click)="deleteTurno(turno, $event)" title="Eliminar Turno">
                        <span class="material-icons">delete</span>
                    </button>
                    }
                </div>
                }
                <button class="btn-outline w-100 mt-2" (click)="selectTurno(turno)">
                    Ver Mesas
                </button>
            </div>
            } @empty {
            <div class="empty-state-card">
                <p>No hay turnos de examen registrados.</p>
            </div>
            }
        </div>
        }

    </div>

    
    @if (showCreateTurnModal) {
    <div class="modal-overlay" (click)="closeCreateTurnModal()">
        <div class="modal-content" (click)="$event.stopPropagation()">
            <h4>{{ isEditingTurn ? 'Editar Turno' : 'Nuevo Turno de Examen' }}</h4>
            <div class="form-group">
                <label>Nombre</label>
                <input type="text" [(ngModel)]="newTurno.nombre" class="form-control" placeholder="Ej: Febrero 2026">
            </div>
            <div class="form-row">
                <div class="form-group">
                    <label>Inicio</label>
                    <input type="date" [(ngModel)]="newTurno.fechaInicio" class="form-control"
                        [disabled]="isEditingTurn && isEditingActiveTurn">
                </div>
                <div class="form-group">
                    <label>Fin</label>
                    <input type="date" [(ngModel)]="newTurno.fechaFin" class="form-control">
                </div>
            </div>
            <div class="modal-actions">
                <button class="btn-secondary" (click)="closeCreateTurnModal()">Cancelar</button>
                <button class="btn-primary" (click)="saveTurno()"
                    [disabled]="!newTurno.nombre || !newTurno.fechaInicio || !newTurno.fechaFin || isLoading">
                    {{ isEditingTurn ? 'Guardar Cambios' : 'Crear Turno' }}
                </button>
            </div>
        </div>
    </div>
    }
    
    @if (showDeleteConfirmation) {
    <app-confirmation-modal title="Confirmar Eliminación"
        message="¿Está seguro de que desea eliminar el turno {{ turnToDelete?.nombre }}? Esta acción no se puede deshacer."
        confirmText="Eliminar" cancelText="Cancelar" type="danger" (confirm)="confirmDelete()" (close)="cancelDelete()">
    </app-confirmation-modal>
    }
</app-page-layout>