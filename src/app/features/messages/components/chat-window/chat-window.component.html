@if (selectedConversation) {
<div class="chat-window">
    <div class="chat-header">
        <div class="avatar-container">
            <div class="avatar-placeholder sm">{{ selectedConversation.nombre.charAt(0) }}</div>
        </div>
        <div class="header-text">
            <h3>{{ selectedConversation.nombre }}</h3>
            <span class="status-text">{{ selectedConversation.cantIntegrantes }} integrantes</span>
        </div>
        <div class="header-actions">
            <button class="icon-btn">
                <span class="material-icons">info</span>
            </button>
        </div>
    </div>

    <div class="messages-list" #scrollContainer>
        @if (isLoading) {
        <div class="flex flex-col items-center justify-center h-full text-secondary">
            <span class="material-icons animate-spin text-4xl mb-2">autorenew</span>
            <p>Cargando historial...</p>
        </div>
        } @else {
        @if (!selectedConversation.esVisible && (!messages || messages.length === 0)) {
        <div class="flex flex-col items-center justify-center h-full text-secondary opacity-50">
            <span class="material-icons text-4xl mb-2">info_outline</span>
            <p>No hay mensajes en la conversación</p>
            <span class="text-xs mt-1">Este grupo se activará con el primer mensaje.</span>
        </div>
        } @else {
        @for (group of groupedMessages; track group.dateLabel) {
        <div class="date-divider">
            <span>{{ group.dateLabel }}</span>
        </div>

        @for (msg of group.messages; track msg.id) {
        <div class="message-wrapper" [class.mine]="isMine(msg)">
            @if (!isMine(msg)) {
            <div class="message-avatar">
                @if (msg.fotoRemitente) {
                <img [src]="getProfileImageUrl(msg.fotoRemitente)" [alt]="msg.nombreRemitente" class="avatar-img">
                } @else {
                <div class="avatar-placeholder xs">
                    {{ getInitials(msg.nombreRemitente, msg.apellidoRemitente) }}
                </div>
                }
            </div>
            }
            <div class="message-content">
                @if (!isMine(msg)) {
                <span class="sender-name">{{ msg.nombreRemitente }} {{ msg.apellidoRemitente }}</span>
                }
                <div class="message-bubble">
                    <p>{{ msg.contenido }}</p>
                    <span class="msg-time">{{ msg.fechaEnvio | date:'HH:mm' }}</span>
                </div>
            </div>
        </div>
        }
        } @empty {
        <div class="flex flex-col items-center justify-center h-full text-secondary opacity-50">
            <span class="material-icons text-4xl mb-2">chat_bubble_outline</span>
            <p>No hay mensajes en este grupo.</p>
        </div>
        }
        }
        }
    </div>

    @if (canSend) {
    <div class="chat-input-area">
        <input type="text" [(ngModel)]="newMessage" placeholder="Escribe un mensaje..."
            (keyup.enter)="handleSendMessage()" [disabled]="!canSend">
        <button class="btn-send" (click)="handleSendMessage()" [disabled]="!newMessage.trim() || !canSend">
            <span class="material-icons">send</span>
        </button>
    </div>
    }
</div>
} @else {
<div class="empty-chat-state">
    <span class="material-icons">forum</span>
    <h3>Tus Mensajes</h3>
    <p>Selecciona una conversación de la lista para comenzar a chatear.</p>
</div>
}