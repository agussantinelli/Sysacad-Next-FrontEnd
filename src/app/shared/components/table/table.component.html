<div class="table-container">
    <table class="data-table">
        <thead>
            <tr>
                <th *ngFor="let col of columns" scope="col" class="header-cell" (click)="sort(col)"
                    [class.sortable]="col.sortable" [style.width]="col.width" [style.text-align]="col.align || 'left'">
                    <div class="header-content w-full" [class.justify-center]="col.align === 'center'"
                        [class.justify-end]="col.align === 'right'">
                        {{ col.label }}
                        <span *ngIf="col.sortable" class="sort-icon">
                            <img *ngIf="sortColumn !== col.key" src="icons/sort-default.svg" alt="Sort" width="12"
                                height="12">
                            <img *ngIf="sortColumn === col.key && sortDirection === 'asc'" src="icons/sort-asc.svg"
                                alt="Ascending" width="12" height="12">
                            <img *ngIf="sortColumn === col.key && sortDirection === 'desc'" src="icons/sort-desc.svg"
                                alt="Descending" width="12" height="12">
                        </span>
                    </div>
                </th>
                <th *ngIf="actions.length > 0" scope="col" class="header-cell">
                    Acciones
                </th>
            </tr>
        </thead>
        <tbody>
            <tr *ngFor="let row of displayData" class="table-row">
                <td *ngFor="let col of columns" class="table-cell" [ngClass]="col.cellClass ? col.cellClass(row) : ''"
                    [style.width]="col.width" [style.text-align]="col.align || 'left'">
                    <ng-container [ngSwitch]="col.type">
                        <span *ngSwitchCase="'date'">{{ getCellValue(row, col) | date:'short' }}</span>
                        <span *ngSwitchCase="'currency'">{{ getCellValue(row, col) | currency }}</span>

                        <!-- Custom: Correlativas Button -->
                        <div *ngSwitchCase="'custom'" class="flex justify-center">
                            <ng-container *ngIf="col.key === 'correlativasDisplay'">
                                <button *ngIf="getCellValue(row, col)?.hasCorrelatives"
                                    (click)="emitAction('viewCorrelatives', row)"
                                    style="background: none; border: none; padding: 0; margin: 0; cursor: pointer; color: white;"
                                    class="inline-flex items-center gap-1.5 hover:opacity-70 transition-opacity">
                                    <span class="material-icons"
                                        style="font-size: 16px; color: white;">visibility</span>
                                    <span class="text-sm font-medium" style="color: white;">{{ getCellValue(row,
                                        col)?.count }}</span>
                                </button>
                                <span *ngIf="!getCellValue(row, col)?.hasCorrelatives"
                                    class="text-gray-400 font-medium text-sm">NO</span>
                            </ng-container>
                        </div>

                        <div *ngSwitchCase="'list'" class="w-full flex flex-col"
                            [class.items-center]="col.align === 'center'"
                            [class.items-start]="!col.align || col.align === 'left'"
                            [class.items-end]="col.align === 'right'">
                            <ng-container *ngIf="getCellValue(row, col) as items">
                                <ng-container *ngIf="col.collapsible !== false">
                                    <button *ngIf="items.length > 0"
                                        (click)="row['isExpanded_' + col.key] = !row['isExpanded_' + col.key]"
                                        class="flex items-center justify-center gap-2 font-medium text-white transition-colors cursor-pointer p-1 rounded hover:bg-black/5"
                                        style="background-color: transparent; border: none; box-shadow: none; color: white !important;">
                                        <span>{{ items.length }}</span>
                                        <img src="icons/chevron-down-light.svg" alt="Expand" width="12" height="12"
                                            class="transform transition-transform duration-200"
                                            [class.rotate-180]="row['isExpanded_' + col.key]">
                                    </button>
                                    <span *ngIf="items.length === 0" class="text-white font-medium py-1"
                                        style="color: white !important;">-</span>

                                    <ul *ngIf="row['isExpanded_' + col.key]"
                                        class="mt-2 w-full text-center space-y-1 animate-fadeIn"
                                        style="white-space: normal; word-wrap: break-word;">
                                        <li *ngFor="let item of items"
                                            class="flex items-center justify-center gap-2 text-xs text-white font-semibold">
                                            <!-- Correlative Name -->
                                            <span class="leading-relaxed uppercase tracking-wider">{{ item.nombre ||
                                                item }}</span>
                                            <!-- Condition Badge (if object with badge property) -->
                                            <span *ngIf="item.badge"
                                                class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold"
                                                [class.bg-green-500]="item.badge === 'P'"
                                                [class.bg-yellow-500]="item.badge === 'R'" [title]="item.condicion">
                                                {{ item.badge }}
                                            </span>
                                        </li>
                                    </ul>
                                </ng-container>
                                <ng-container *ngIf="col.collapsible === false">
                                    <ul class="w-full space-y-1" style="white-space: normal; word-wrap: break-word;">
                                        <li *ngFor="let item of items"
                                            class="flex gap-2 text-xs text-secondary-200 font-medium"
                                            [class.justify-center]="col.align === 'center'"
                                            [class.justify-start]="!col.align || col.align === 'left'"
                                            [class.justify-end]="col.align === 'right'">
                                            <span class="leading-relaxed">{{ item.nombre || item }}</span>
                                            <span *ngIf="item.badge"
                                                class="inline-block px-1.5 py-0.5 rounded text-[10px] font-bold"
                                                [class.bg-green-500]="item.badge === 'P'"
                                                [class.bg-yellow-500]="item.badge === 'R'" [title]="item.condicion">
                                                {{ item.badge }}
                                            </span>
                                        </li>
                                        <span *ngIf="items.length === 0">-</span>
                                    </ul>
                                </ng-container>
                            </ng-container>
                        </div>
                        <span *ngSwitchDefault>{{ getCellValue(row, col) }}</span>
                    </ng-container>
                </td>
                <td *ngIf="actions.length > 0" class="table-cell actions-cell">
                    <ng-container *ngFor="let action of actions">
                        <button *ngIf="!action.isVisible || action.isVisible(row)"
                            (click)="emitAction(action.name, row)" class="action-btn" [ngClass]="action.class">
                            {{ action.label }}
                        </button>
                    </ng-container>
                </td>
            </tr>
            <tr *ngIf="isLoading">
                <td [attr.colspan]="columns.length + (actions.length > 0 ? 1 : 0)" class="p-8 text-center">
                    <app-loading-spinner message="Cargando datos..."></app-loading-spinner>
                </td>
            </tr>
            <tr *ngIf="displayData.length === 0 && !isLoading">
                <td [attr.colspan]="columns.length + (actions.length > 0 ? 1 : 0)" class="empty-state">
                    No hay datos disponibles.
                </td>
            </tr>
        </tbody>
    </table>

    <nav class="pagination-container" aria-label="Table navigation">
        <span class="pagination-info">
            Mostrando <strong>{{ (currentPage - 1) * pageSize + 1 }}</strong>
            - <strong>{{ Math.min(currentPage * pageSize, data.length) }}</strong>
            de <strong>{{ data.length }}</strong>
        </span>
        <div class="pagination-controls">
            <button (click)="changePage(currentPage - 1)" [disabled]="currentPage === 1" class="page-btn prev">
                Anterior
            </button>
            <span class="page-indicator">
                {{ currentPage }} / {{ totalPages }}
            </span>
            <button (click)="changePage(currentPage + 1)" [disabled]="currentPage === totalPages" class="page-btn next">
                Siguiente
            </button>
        </div>
    </nav>
</div>